<!DOCTYPE html>
<html lang="ko">

<head>
    <title>WebSocket Chat</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
</head>

<body>

<h2>WebSocket Chat</h2>
<div id="messageArea"></div>

<input type="text" id="messageInput" placeholder="Type a message..."/>
<button onclick="sendMessage()">Send</button>

<br>
<input type="text" id="roomNameInput" placeholder="Enter Room Name"/>
<button onclick="joinRoomByName(document.getElementById('roomNameInput').value)">Join Room</button>
<button onclick="fetchChatHistory()">fetchChatHistory</button>
<button onclick="searchChatMessages()">searchChatMessages</button>

<br>
<input type="text" id="roomName" placeholder="Room Name"/>
<button onclick="createRoom()">Create Room</button>

<br>
<input type="text" id="userIdInput" placeholder="Enter your user ID"/>
<button onclick="setUserId()">Set User ID</button>
<button onclick="getRoomsByUserId(document.getElementById('userIdInput').value)">Lookup My Rooms</button>

<script>
    var stompClient = null;
    var currentRoomId = null;
    var currentUserId = null;

    function sendMessage() {
        var messageContent = document.getElementById('messageInput').value;
        if (messageContent && stompClient) {
            var chatMessage = {
                type: 'TALK',
                roomId: currentRoomId,
                sender: currentUserId,
                message: messageContent
            };
            stompClient.send(`/app/chat.sendMessage/${currentRoomId}`, {}, JSON.stringify(chatMessage));
            document.getElementById('messageInput').value = '';
        }
    }

    function showMessage(messageContent) {
        var messageArea = document.getElementById('messageArea');
        var messageElement = document.createElement('div');
        messageElement.textContent = messageContent; // 메시지 표시
        messageArea.appendChild(messageElement);
    }

    function createRoom() {
        var roomName = document.getElementById('roomName').value;
        if (roomName && currentUserId) {
            fetch(`/chat/createRoom`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name: roomName, userId: currentUserId })
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        // 오류 처리
                        console.error('Room creation failed');
                        return null;
                    }
                })
                .then(data => {
                    console.log('Room created:', data);
                    // 방 생성 후 방에 자동으로 참여
                    if (data && data.roomId) {
                        joinRoomByName(roomName);
                    }
                })
                .catch(error => {
                    console.error('Error creating room:', error);
                });
        }
    }

    function joinRoomByName(roomName) {
        if (roomName && currentUserId) {
            fetch(`/chat/joinRoomByName`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ roomName: roomName, userId: currentUserId })
            })
                .then(response => {
                    if (response.ok) {
                        return response.json();
                    } else {
                        console.error('Error joining room');
                        return null;
                    }
                })
                .then(data => {
                    if (data && data.roomId) {
                        console.log(`Joined room: ${roomName}`);
                        connectAndSubscribe(data.roomId);
                    } else {
                        console.error('No roomId received');
                    }
                })
                .catch(error => {
                    console.error('Error joining room:', error);
                });
        }
    }

    function connectAndSubscribe(roomId) {
        var socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        currentRoomId = roomId;

        stompClient.connect({}, function(frame) {
            console.log('Connected: ' + frame);
            stompClient.subscribe(`/topic/${roomId}`, function(message) {
                var messageContent = JSON.parse(message.body).message;
                var messageSender = JSON.parse(message.body).sender;
                showMessage(`${messageSender}: ${messageContent}`);
            });
        });
    }

    function setUserId() {
        var userId = document.getElementById('userIdInput').value;
        if (userId) {
            currentUserId = userId;
            console.log(`User ID set to: ${currentUserId}`);
        }
    }

    function getRoomsByUserId(userId) {
        fetch(`/chat/roomsByUser/${userId}`)
            .then(response => response.json())
            .then(rooms => {
                console.log('Rooms:', rooms);
                // 여기서 rooms는 사용자가 속한 채팅방 목록입니다.
                // 필요한 대로 목록을 표시하거나 다른 처리를 수행합니다.
            })
            .catch(error => {
                console.error('Error fetching rooms:', error);
            });
    }

    function fetchChatHistory() {
        // currentRoomId = document.getElementById('currentRoomId').value
        roomId = currentRoomId
        fetch(`/chat/chatHistory/${roomId}`)
            .then(response => response.json())
            .then(chatHistory => {
                console.log('Chat History:', chatHistory);
                // 채팅 내역을 화면에 표시하는 로직
                chatHistory.forEach(message => {
                    var messageContent = message.message; // 메시지 내용 직접 접근
                    var messageSender = message.sender; // 메시지 발신자 직접 접근
                    showMessage(`${messageSender}: ${messageContent}`);
                });
            })
            .catch(error => {
                console.error('Error fetching chat history:', error);
            });
    }

    function searchChatMessages() {
        var roomId = currentRoomId; // 현재 채팅방 ID
        var keyword = document.getElementById('searchInput').value; // 검색어 입력 필드

        if (roomId && keyword) {
            fetch(`/chat/searchChat/${roomId}?keyword=${encodeURIComponent(keyword)}`)
                .then(response => response.json())
                .then(chatMessages => {
                    console.log('Search results:', chatMessages);
                    // 검색 결과를 화면에 표시하는 로직
                })
                .catch(error => {
                    console.error('Error searching chat messages:', error);
                });
        }
    }

</script>
</body>
</html>
